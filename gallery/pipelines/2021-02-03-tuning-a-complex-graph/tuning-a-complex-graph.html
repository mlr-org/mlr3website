<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.26">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Lennart Schneider">
<meta name="dcterms.date" content="2021-02-03">
<meta name="description" content="Tune a preprocessing pipeline and multiple tuners at once.">

<title>Tuning a Complex Graph – mlr-org</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-587c61ba64f3a5504c4d52d930310e48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-1fa5e93acb50773330e542bbd58c1e25.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 2,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 5,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="../../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="../../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../../../site_libs/datatables-binding-0.30/datatables.js"></script>
<script src="../../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../../../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../../../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="../../../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../../../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">mlr-org</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-overview" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Overview</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-overview">    
        <li>
    <a class="dropdown-item" href="../../../ecosystem.html">
 <span class="dropdown-text">Ecosystem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../dependencies.html">
 <span class="dropdown-text">Dependencies</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../tasks.html">
 <span class="dropdown-text">Tasks</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../learners.html">
 <span class="dropdown-text">Learners</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../resamplings.html">
 <span class="dropdown-text">Resamplings</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../measures.html">
 <span class="dropdown-text">Measures</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../pipeops.html">
 <span class="dropdown-text">Pipeline Operators</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../graphs.html">
 <span class="dropdown-text">Graphs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../torch_pipeops.html">
 <span class="dropdown-text">Torch Pipeline Operators</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../tuners.html">
 <span class="dropdown-text">Tuners</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../tuning_spaces.html">
 <span class="dropdown-text">Tuning Spaces</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../terminators.html">
 <span class="dropdown-text">Terminators</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../filters.html">
 <span class="dropdown-text">Feature Selection Filter</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../fselectors.html">
 <span class="dropdown-text">Feature Selection Wrapper</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../book.html"> 
<span class="menu-text">Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../gallery.html"> 
<span class="menu-text">Gallery</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-benchmarks" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Benchmarks</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-benchmarks">    
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3.html">
 <span class="dropdown-text">mlr3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3fselect.html">
 <span class="dropdown-text">mlr3fselect</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3tuning.html">
 <span class="dropdown-text">mlr3tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_async.html">
 <span class="dropdown-text">mlr3tuning async</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmark_rush.html">
 <span class="dropdown-text">rush</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_paradox.html">
 <span class="dropdown-text">paradox</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../team.html"> 
<span class="menu-text">Team</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-more" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">More</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-more">    
        <li>
    <a class="dropdown-item" href="../../../support.html">
 <span class="dropdown-text">Support</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../contributing.html">
 <span class="dropdown-text">Contributing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../faq.html">
 <span class="dropdown-text">Frequently Asked Questions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../blogroll.html">
 <span class="dropdown-text">Blogroll</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-rss" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-rss">    
        <li>
    <a class="dropdown-item" href="../../../gallery-all.xml">
 <span class="dropdown-text">Gallery RSS</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite"> <i class="bi bi-chat-dots" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"> <i class="bi bi-stack-overflow" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mlr-org"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tuning a Complex Graph</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
  <div id="quarto-announcement" data-announcement-id="2a29a73f7e8b4063ece399653c838ff3" class="alert alert-primary hidden"><i class="bi bi-info-circle quarto-announcement-icon"></i><div class="quarto-announcement-content">
<p>The website features runtime <a href="benchmarks/benchmarks_paradox.qmd">benchmarks</a> of the paradox package now.</p>
</div><i class="bi bi-x-lg quarto-announcement-action"></i></div>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Tuning a Complex Graph</h1>
                  <div>
        <div class="description">
          <p>Tune a preprocessing pipeline and multiple tuners at once.</p>
        </div>
      </div>
                  <div class="banner">
        <img src="thumbnail.png" class="banner__image">
                  </div>
  </div>

  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Lennart Schneider </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 3, 2021</p>
      </div>
    </div>
    
      
    </div>
    

  </div></header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#data-and-task" id="toc-data-and-task" class="nav-link active" data-scroll-target="#data-and-task">Data and Task</a></li>
  <li><a href="#workflow" id="toc-workflow" class="nav-link" data-scroll-target="#workflow">Workflow</a></li>
  <li><a href="#baseline" id="toc-baseline" class="nav-link" data-scroll-target="#baseline">Baseline</a></li>
  <li><a href="#branching" id="toc-branching" class="nav-link" data-scroll-target="#branching">Branching</a></li>
  <li><a href="#search-space" id="toc-search-space" class="nav-link" data-scroll-target="#search-space">Search Space</a></li>
  <li><a href="#tuning" id="toc-tuning" class="nav-link" data-scroll-target="#tuning">Tuning</a></li>
  <li><a href="#proxy" id="toc-proxy" class="nav-link" data-scroll-target="#proxy">Proxy</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">




<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># include: false</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">"bst"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: bst</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">requireNamespace</span>(<span class="st">"fastICA"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required namespace: fastICA</code></pre>
</div>
</div>
<p>In this use case we show how to tune a rather complex graph consisting of different preprocessing steps and different learners where each preprocessing step and learner itself has parameters that can be tuned. You will learn the following:</p>
<ul>
<li>Build a <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> that consists of two common preprocessing steps, then switches between two dimensionality reduction techniques followed by a <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a> vs.&nbsp;no dimensionality reduction followed by another <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a></li>
<li>Define the search space for tuning that handles inter-dependencies between pipeline steps and hyperparameters</li>
<li>Run a <a href="https://mlr3tuning.mlr-org.com/reference/mlr_tuners_grid_search.html"><code>grid search</code></a> to find an optimal choice of preprocessing steps and hyperparameters.</li>
</ul>
<p>Ideally you already had a look at how to tune over <a href="https://mlr3gallery.mlr-org.com/posts/2020-02-01-tuning-multiplexer/">multiple learners</a>.</p>
<p>First, we load the packages we will need:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We initialize the random number generator with a fixed seed for reproducibility, and decrease the verbosity of the logger to keep the output clearly represented. The <a href="https://mlr3book.mlr-org.com/logging.html"><code>lgr</code></a> package is used for logging in all <a href="https://mlr3.mlr-org.com">mlr3</a> packages. The <a href="https://mlr3.mlr-org.com">mlr3</a> logger prints the logging messages from the base package, whereas the <a href="https://bbotk.mlr-org.com">bbotk</a> logger is responsible for logging messages from the optimization packages (e.g.&nbsp;<a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a> ).</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7832</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<section id="data-and-task" class="level2">
<h2 class="anchored" data-anchor-id="data-and-task">Data and Task</h2>
<p>We are going to work with some gene expression data included as a supplement in the <a href="https://cran.r-project.org/package=bst">bst</a> package. The data consists of 2308 gene profiles in 63 training and 20 test samples. The following data preprocessing steps are done analogously as in <code>vignette("khan", package = "bst")</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>datafile <span class="ot">=</span> <span class="fu">system.file</span>(<span class="st">"extdata"</span>, <span class="st">"supplemental_data"</span>, <span class="at">package =</span> <span class="st">"bst"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">=</span> <span class="fu">read.delim</span>(datafile, <span class="at">header =</span> <span class="cn">TRUE</span>, <span class="at">skip =</span> <span class="dv">1</span>)[, <span class="sc">-</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>dat0 <span class="ot">=</span> <span class="fu">t</span>(dat0)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">=</span> <span class="fu">data.frame</span>(dat0[<span class="sc">!</span>(<span class="fu">rownames</span>(dat0) <span class="sc">%in%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"TEST.9"</span>, <span class="st">"TEST.13"</span>, <span class="st">"TEST.5"</span>, <span class="st">"TEST.3"</span>, <span class="st">"TEST.11"</span>)), ])</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>class <span class="ot">=</span> <span class="fu">as.factor</span>(</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="fu">substr</span>(<span class="fu">rownames</span>(dat)[<span class="dv">1</span><span class="sc">:</span><span class="dv">63</span>], <span class="at">start =</span> <span class="dv">1</span>, <span class="at">stop =</span> <span class="dv">2</span>),</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"NB"</span>, <span class="st">"RM"</span>, <span class="st">"NB"</span>, <span class="st">"EW"</span>, <span class="st">"RM"</span>, <span class="st">"BL"</span>, <span class="st">"EW"</span>, <span class="st">"RM"</span>, <span class="st">"EW"</span>, <span class="st">"EW"</span>, <span class="st">"EW"</span>, <span class="st">"RM"</span>,</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="st">"BL"</span>, <span class="st">"RM"</span>, <span class="st">"NB"</span>, <span class="st">"NB"</span>, <span class="st">"NB"</span>, <span class="st">"NB"</span>, <span class="st">"BL"</span>, <span class="st">"EW"</span>)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then construct our training and test <a href="https://mlr3.mlr-org.com/reference/Task.html"><code>Task</code></a> :</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">as_task_classif</span>(dat, <span class="at">target =</span> <span class="st">"class"</span>, <span class="at">id =</span> <span class="st">"SRBCT"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>task_train <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>(<span class="at">deep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>task_train<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">63</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>task_test <span class="ot">=</span> task<span class="sc">$</span><span class="fu">clone</span>(<span class="at">deep =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>task_test<span class="sc">$</span><span class="fu">filter</span>(<span class="dv">64</span><span class="sc">:</span><span class="dv">83</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="workflow" class="level2">
<h2 class="anchored" data-anchor-id="workflow">Workflow</h2>
<p>Our graph will start with log transforming the features, followed by scaling them. Then, either a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html"><code>PCA</code></a> or <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_ica.html"><code>ICA</code></a> is applied to extract principal / independent components followed by fitting a <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.lda.html"><code>LDA</code></a> or a <a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.ranger.html"><code>ranger random forest</code></a> is fitted without any preprocessing (the log transformation and scaling should most likely affect the <code>LDA</code> more than the <code>ranger random forest</code>). Regarding the <code>PCA</code> and <code>ICA</code>, both the number of principal / independent components are tuning parameters. Regarding the <code>LDA</code>, we can further choose different methods for estimating the mean and variance and regarding the <code>ranger</code>, we want to tune the <code>mtry</code> and <code>num.tree</code> parameters. Note that the <code>PCA-LDA</code> combination has already been successfully applied in different cancer diagnostic contexts when the feature space is of high dimensionality <span class="citation" data-cites="morais2018">(<a href="#ref-morais2018" role="doc-biblioref">Morais and Lima 2018</a>)</span>.</p>
<p>To allow for switching between the <code>PCA</code> / <code>ICA</code>-<code>LDA</code> and <code>ranger</code> we can either use branching or proxy pipelines, i.e., <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_branch.html"><code>PipeOpBranch</code></a> and <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_unbranch.html"><code>PipeOpUnbranch</code></a> or <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_proxy.html"><code>PipeOpProxy</code></a>. We will first cover branching in detail and later show how the same can be done using <code>PipeOpProxy</code>.</p>
</section>
<section id="baseline" class="level2">
<h2 class="anchored" data-anchor-id="baseline">Baseline</h2>
<p>First, we have a look at the baseline <a href="https://mlr3.mlr-org.com/reference/mlr_measures_classif.acc.html"><code>classification accuracy</code></a> of the <code>LDA</code> and <code>ranger</code> on the training task:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>base <span class="ot">=</span> <span class="fu">benchmark</span>(<span class="fu">benchmark_grid</span>(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  task_train,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learners =</span> <span class="fu">list</span>(<span class="fu">lrn</span>(<span class="st">"classif.lda"</span>), <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)),</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamplings =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>)))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in lda.default(x, grouping, ...): variables are collinear

Warning in lda.default(x, grouping, ...): variables are collinear

Warning in lda.default(x, grouping, ...): variables are collinear</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>base<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id     learner_id resampling_id iters classif.acc
1:  1   SRBCT    classif.lda            cv     3   0.6666667
2:  2   SRBCT classif.ranger            cv     3   0.9206349
Hidden columns: resample_result</code></pre>
</div>
</div>
<p>The out-of-the-box <code>ranger</code> appears to already have good performance on the training task. Regarding the <code>LDA</code>, we do get a warning message that some features are colinear. This strongly suggests to reduce the dimensionality of the feature space. Let’s see if we can get some better performance, at least for the <code>LDA</code>.</p>
</section>
<section id="branching" class="level2">
<h2 class="anchored" data-anchor-id="branching">Branching</h2>
<p>Our graph starts with log transforming the features (we explicitly use base 10 only for better interpretability when inspecting the model later), using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_colapply.html"><code>PipeOpColApply</code></a>, followed by scaling the features using <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_scale.html"><code>PipeOpScale</code></a>. Then, the first branch allows for switching between the <code>PCA</code> / <code>ICA</code>-<code>LDA</code> and <code>ranger</code>, and within <code>PCA</code> / <code>ICA</code>-<code>LDA</code>, the second branch allows for switching between <code>PCA</code> and <code>ICA</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>graph1 <span class="ot">=</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"colapply"</span>, <span class="at">applicator =</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x, <span class="at">base =</span> <span class="dv">10</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># pca / ica followed by lda vs. ranger</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="at">id =</span> <span class="st">"branch_learner"</span>, <span class="at">options =</span> <span class="fu">c</span>(<span class="st">"pca_ica_lda"</span>, <span class="st">"ranger"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="at">id =</span> <span class="st">"branch_preproc_lda"</span>, <span class="at">options =</span> <span class="fu">c</span>(<span class="st">"pca"</span>, <span class="st">"ica"</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">gunion</span>(<span class="fu">list</span>(</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">po</span>(<span class="st">"pca"</span>), <span class="fu">po</span>(<span class="st">"ica"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>      )) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="at">id =</span> <span class="st">"unbranch_preproc_lda"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lrn</span>(<span class="st">"classif.lda"</span>),</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>, <span class="at">id =</span> <span class="st">"unbranch_learner"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Note that the names of the options within each branch are arbitrary, but ideally they describe what is happening. Therefore we go with <code>"pca_ica_lda"</code> / <code>"ranger</code>” and <code>"pca"</code> / <code>"ica"</code>. Finally, we also could have used the <code>branch</code> <a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html"><code>ppl</code></a> to make branching easier (we will come back to this in the <a href="#Proxy">Proxy</a> section). The graph looks like the following:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tuning-a-complex-graph_files/figure-html/tuning-a-complex-graph-009-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>We can inspect the parameters of the <a href="https://paradox.mlr-org.com/reference/ParamSet.html"><code>ParamSet</code></a> of the graph to see which parameters can be set:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">ids</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "colapply.applicator"                         "colapply.affect_columns"                    
 [3] "scale.center"                                "scale.scale"                                
 [5] "scale.robust"                                "scale.affect_columns"                       
 [7] "branch_learner.selection"                    "branch_preproc_lda.selection"               
 [9] "pca.center"                                  "pca.scale."                                 
[11] "pca.rank."                                   "pca.affect_columns"                         
[13] "ica.n.comp"                                  "ica.alg.typ"                                
[15] "ica.fun"                                     "ica.alpha"                                  
[17] "ica.method"                                  "ica.row.norm"                               
[19] "ica.maxit"                                   "ica.tol"                                    
[21] "ica.verbose"                                 "ica.w.init"                                 
[23] "ica.affect_columns"                          "classif.lda.dimen"                          
[25] "classif.lda.method"                          "classif.lda.nu"                             
[27] "classif.lda.predict.method"                  "classif.lda.predict.prior"                  
[29] "classif.lda.prior"                           "classif.lda.tol"                            
[31] "classif.ranger.alpha"                        "classif.ranger.always.split.variables"      
[33] "classif.ranger.class.weights"                "classif.ranger.holdout"                     
[35] "classif.ranger.importance"                   "classif.ranger.keep.inbag"                  
[37] "classif.ranger.max.depth"                    "classif.ranger.min.node.size"               
[39] "classif.ranger.min.prop"                     "classif.ranger.minprop"                     
[41] "classif.ranger.mtry"                         "classif.ranger.mtry.ratio"                  
[43] "classif.ranger.num.random.splits"            "classif.ranger.num.threads"                 
[45] "classif.ranger.num.trees"                    "classif.ranger.oob.error"                   
[47] "classif.ranger.regularization.factor"        "classif.ranger.regularization.usedepth"     
[49] "classif.ranger.replace"                      "classif.ranger.respect.unordered.factors"   
[51] "classif.ranger.sample.fraction"              "classif.ranger.save.memory"                 
[53] "classif.ranger.scale.permutation.importance" "classif.ranger.se.method"                   
[55] "classif.ranger.seed"                         "classif.ranger.split.select.weights"        
[57] "classif.ranger.splitrule"                    "classif.ranger.verbose"                     
[59] "classif.ranger.write.forest"                </code></pre>
</div>
</div>
<p>The <code>id</code>’s are prefixed by the respective <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> they belong to, e.g., <code>pca.rank.</code> refers to the <code>rank.</code> parameter of <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_pca.html"><code>PipeOpPCA</code></a>.</p>
</section>
<section id="search-space" class="level2">
<h2 class="anchored" data-anchor-id="search-space">Search Space</h2>
<p>Our graph either fits a <code>LDA</code> after applying <code>PCA</code> or <code>ICA</code>, or alternatively a <code>ranger</code> with no preprocessing. These two <strong>options</strong> each define selection parameters that we can tune. Moreover, within the respective <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>’s we want to tune the following parameters: <code>pca.rank.</code>, <code>ica.n.comp</code>, <code>classif.lda.method</code>, <code>classif.ranger.mtry</code>, and <code>classif.ranger.num.trees</code>. The first two parameters are integers that in-principal could range from 1 to the number of features. However, for <code>ICA</code>, the upper bound must not exceed the number of observations and as we will later use <code>3-fold</code> <a href="https://mlr3.mlr-org.com/reference/mlr_resamplings_cv.html"><code>cross-validation</code></a> as the resampling method for the tuning, we just set the upper bound to 30 (and do the same for <code>PCA</code>). Regarding the <code>classif.lda.method</code> we will only be interested in <code>"moment"</code> estimation vs.&nbsp;minimum volume ellipsoid covariance estimation (<code>"mve"</code>). Moreover, we set the lower bound of <code>classif.ranger.mtry</code> to 200 (which is around the number of features divided by 10) and the upper bound to 1000.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>tune_ps1 <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch_learner.selection =</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"pca_ica_lda"</span>, <span class="st">"ranger"</span>)),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch_preproc_lda.selection =</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"pca"</span>, <span class="st">"ica"</span>), <span class="at">depends =</span> branch_learner.selection <span class="sc">==</span> <span class="st">"pca_ica_lda"</span>),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pca.rank. =</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_int</span>(<span class="dv">1</span>, <span class="dv">30</span>, <span class="at">depends =</span> branch_preproc_lda.selection <span class="sc">==</span> <span class="st">"pca"</span>),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">ica.n.comp =</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_int</span>(<span class="dv">1</span>, <span class="dv">30</span>, <span class="at">depends =</span> branch_preproc_lda.selection <span class="sc">==</span> <span class="st">"ica"</span>),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.lda.method =</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"moment"</span>, <span class="st">"mve"</span>), <span class="at">depends =</span> branch_preproc_lda.selection <span class="sc">==</span> <span class="st">"ica"</span>),</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.ranger.mtry =</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_int</span>(<span class="dv">200</span>, <span class="dv">1000</span>, <span class="at">depends =</span> branch_learner.selection <span class="sc">==</span> <span class="st">"ranger"</span>),</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.ranger.num.trees =</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">p_int</span>(<span class="dv">500</span>, <span class="dv">2000</span>, <span class="at">depends =</span> branch_learner.selection <span class="sc">==</span> <span class="st">"ranger"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The parameter <code>branch_learner.selection</code> defines whether we go down the left (<code>PCA</code> / <code>ICA</code> followed by <code>LDA</code>) or the right branch (<code>ranger</code>). The parameter <code>branch_preproc_lda.selection</code> defines whether a <code>PCA</code> or <code>ICA</code> will be applied prior to the <code>LDA</code>. The other parameters directly belong to the <code>ParamSet</code> of the <code>PCA</code> / <code>ICA</code> / <code>LDA</code> / <code>ranger</code>. Note that it only makes sense to switch between <code>PCA</code> / <code>ICA</code> if the <code>"pca_ica_lda"</code> branch was selected beforehand. We have to specify this via the <code>depends</code> parameter.</p>
<p>Finally, we also could have proceeded to tune the numeric parameters on a log scale. I.e., looking at <code>pca.rank.</code> the performance difference between rank 1 and 2 is probably much larger than between rank 29 and rank 30. The <a href="https://mlr3gallery.mlr-org.com/posts/2020-03-11-mlr3tuning-tutorial-german-credit/#random-search-and-transformation">mlr3tuning Tutorial</a> covers such transformations.</p>
</section>
<section id="tuning" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="tuning">Tuning</h2>
<p>We can now tune the parameters of our graph as defined in the search space with respect to a measure. We will use the <a href="https://mlr3.mlr-org.com/reference/mlr_measures_classif.acc.html"><code>classification accuracy</code></a>. As a resampling method we use <a href="https://mlr3.mlr-org.com/reference/mlr_resamplings_cv.html"><code>3-fold cross-validation</code></a>. We will use the <a href="https://bbotk.mlr-org.com/reference/mlr_terminators_none.html"><code>TerminatorNone</code></a> (i.e., no early termination) for terminating the tuning because we will apply a <a href="https://mlr3tuning.mlr-org.com/reference/mlr_tuners_grid_search.html"><code>grid search</code></a> (we use a <code>grid search</code> because it gives nicely plottable and understandable results but if there were much more parameters, <a href="https://mlr3tuning.mlr-org.com/reference/mlr_tuners_random_search.html"><code>random search</code></a> or more intelligent optimization methods would be preferred to a <code>grid search</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>tune1 <span class="ot">=</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  task_train,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph1,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> tune_ps1,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>We then perform a <code>grid search</code> using a resolution of 4 for the numeric parameters. The grid being used will look like the following (note that the dependencies we specified above are handled automatically):</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">generate_design_grid</span>(tune_ps1, <span class="at">resolution =</span> <span class="dv">4</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display column-page">
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-ea17b0379ba6180cc546" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-ea17b0379ba6180cc546">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28"],["pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger"],["pca","pca","pca","pca","ica","ica","ica","ica","ica","ica","ica","ica",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[1,10,20,30,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,1,1,10,10,20,20,30,30,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,"moment","mve","moment","mve","moment","mve","moment","mve",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],[null,null,null,null,null,null,null,null,null,null,null,null,200,200,200,200,466,466,466,466,733,733,733,733,1000,1000,1000,1000],[null,null,null,null,null,null,null,null,null,null,null,null,500,1000,1500,2000,500,1000,1500,2000,500,1000,1500,2000,500,1000,1500,2000]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>branch_learner.selection<\/th>\n      <th>branch_preproc_lda.selection<\/th>\n      <th>pca.rank.<\/th>\n      <th>ica.n.comp<\/th>\n      <th>classif.lda.method<\/th>\n      <th>classif.ranger.mtry<\/th>\n      <th>classif.ranger.num.trees<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,6,7]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We trigger the tuning.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>tuner_gs <span class="ot">=</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>, <span class="at">resolution =</span> <span class="dv">4</span>, <span class="at">batch_size =</span> <span class="dv">10</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>tuner_gs<span class="sc">$</span><span class="fu">optimize</span>(tune1)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>   branch_learner.selection branch_preproc_lda.selection pca.rank. ica.n.comp classif.lda.method classif.ranger.mtry
1:              pca_ica_lda                          ica        NA         10                mve                  NA
   classif.ranger.num.trees learner_param_vals  x_domain classif.acc
1:                       NA          &lt;list[8]&gt; &lt;list[4]&gt;    0.984127</code></pre>
</div>
</div>
<p>Now, we can inspect the results ordered by the <code>classification accuracy</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(tune1<span class="sc">$</span>archive)[<span class="fu">order</span>(classif.acc), ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell page-columns page-full" data-layout-align="center">
<div class="cell-output-display column-page">
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-fe8ee9badd6991289a71" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-fe8ee9badd6991289a71">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28"],["pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","ranger","pca_ica_lda","pca_ica_lda","ranger","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda","pca_ica_lda"],["ica","ica","pca","ica",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"pca","ica",null,"ica","pca","ica","pca","ica","ica"],[null,null,1,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,10,null,null,null,30,null,20,null,null],[1,1,null,20,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,10,null,30,null,30,null,20,10],["mve","moment",null,"mve",null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,"moment",null,"moment",null,"mve",null,"moment","mve"],[null,null,null,null,200,466,733,733,1000,200,466,733,733,1000,466,1000,1000,200,466,null,null,200,null,null,null,null,null,null],[null,null,null,null,500,1000,500,1500,500,1000,1500,1000,2000,1000,2000,1500,2000,2000,500,null,null,1500,null,null,null,null,null,null],[0.253968253968254,0.3174603174603174,0.3174603174603174,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9206349206349206,0.9365079365079365,0.9365079365079365,0.9365079365079365,0.9365079365079365,0.9365079365079365,0.9523809523809523,0.9523809523809523,0.9523809523809523,0.9682539682539683,0.9682539682539683,0.9841269841269841],[158.678,157.359,6.328000000000031,160.782,3.472999999999985,6.338000000000022,5.524000000000001,9.275000000000034,5.815999999999974,6.283000000000015,7.986999999999966,8.467000000000098,11.90299999999991,8.816000000000031,10.40400000000011,16.21999999999991,15.69500000000005,7.892000000000053,5.793000000000006,5.363000000000056,156.013,6.757000000000062,151.649,2.55699999999996,161.1500000000001,2.899999999999977,158.3350000000002,159.501],["2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:24:35Z","2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:22:07Z","2023-11-03T13:24:35Z","2023-11-03T13:24:35Z","2023-11-03T13:24:35Z","2023-11-03T13:24:35Z","2023-11-03T13:24:35Z","2023-11-03T13:27:13Z","2023-11-03T13:27:13Z","2023-11-03T13:27:13Z","2023-11-03T13:24:35Z","2023-11-03T13:24:35Z","2023-11-03T13:27:13Z","2023-11-03T13:27:13Z","2023-11-03T13:27:13Z","2023-11-03T13:22:07Z","2023-11-03T13:27:13Z","2023-11-03T13:27:13Z","2023-11-03T13:24:35Z","2023-11-03T13:27:13Z","2023-11-03T13:22:07Z"],[1,1,2,1,1,1,1,1,1,2,2,2,2,2,3,3,3,2,2,3,3,3,1,3,3,2,3,1],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>branch_learner.selection<\/th>\n      <th>branch_preproc_lda.selection<\/th>\n      <th>pca.rank.<\/th>\n      <th>ica.n.comp<\/th>\n      <th>classif.lda.method<\/th>\n      <th>classif.ranger.mtry<\/th>\n      <th>classif.ranger.num.trees<\/th>\n      <th>classif.acc<\/th>\n      <th>runtime_learners<\/th>\n      <th>timestamp<\/th>\n      <th>batch_nr<\/th>\n      <th>warnings<\/th>\n      <th>errors<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":[3,4,6,7,8,9,11,12,13]},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We achieve very good accuracy using <code>ranger</code>, more or less regardless how <code>mtry</code> and <code>num.trees</code> are set. However, the <code>LDA</code> also shows very good accuracy when combined with <code>PCA</code> or <code>ICA</code> retaining 30 components.</p>
<p>For now, we decide to use <code>ranger</code> with <code>mtry</code> set to 200 and <code>num.trees</code> set to 1000.</p>
<p>Setting these parameters manually in our graph, then training on the training task and predicting on the test task yields an accuracy of:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>branch_learner.selection <span class="ot">=</span> <span class="st">"ranger"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>classif.ranger.mtry <span class="ot">=</span> <span class="dv">200</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>classif.ranger.num.trees <span class="ot">=</span> <span class="dv">1000</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span><span class="fu">train</span>(task_train)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$unbranch_learner.output
NULL</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>graph1<span class="sc">$</span><span class="fu">predict</span>(task_test)[[<span class="dv">1</span>L]]<span class="sc">$</span><span class="fu">score</span>(<span class="fu">msr</span>(<span class="st">"classif.acc"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>classif.acc 
          1 </code></pre>
</div>
</div>
<p>Note that we also could have wrapped our graph in a <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_learners_graph.html"><code>GraphLearner</code></a> and proceeded to use this as a learner in an <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a>.</p>
</section>
<section id="proxy" class="level2">
<h2 class="anchored" data-anchor-id="proxy">Proxy</h2>
<p>Instead of using branches to split our graph with respect to the learner and preprocessing options, we can also use <a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_proxy.html"><code>PipeOpProxy</code></a>. <code>PipeOpProxy</code> accepts a single <code>content</code> parameter that can contain any other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>. This is extremely flexible in the sense that we do not have to specify our options during construction. However, the parameters of the contained <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a> are no longer directly contained in the <code>ParamSet</code> of the resulting graph. Therefore, when tuning the graph, we do have to make use of a <code>trafo</code> function.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>graph2 <span class="ot">=</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"colapply"</span>, <span class="at">applicator =</span> <span class="cf">function</span>(x) <span class="fu">log</span>(x, <span class="at">base =</span> <span class="dv">10</span>)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"scale"</span>) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"proxy"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This graph now looks like the following:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>graph2<span class="sc">$</span><span class="fu">plot</span>(<span class="at">html =</span> <span class="cn">FALSE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="tuning-a-complex-graph_files/figure-html/tuning-a-complex-graph-022, graph2-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>At first, this may look like a linear graph. However, as the <code>content</code> parameter of <code>PipeOpProxy</code> can be tuned and set to contain any other <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a> or <a href="https://mlr3pipelines.mlr-org.com/reference/Graph.html"><code>Graph</code></a>, this will allow for a similar non-linear graph as when doing branching.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>graph2<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">ids</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "colapply.applicator"     "colapply.affect_columns" "scale.center"            "scale.scale"            
[5] "scale.robust"            "scale.affect_columns"    "proxy.content"          </code></pre>
</div>
</div>
<p>We can tune the graph by using the same search space as before. However, here the <code>trafo</code> function is of central importance to actually set our options and parameters:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tune_ps2 <span class="ot">=</span> tune_ps1<span class="sc">$</span><span class="fu">clone</span>(<span class="at">deep =</span> <span class="cn">TRUE</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The <code>trafo</code> function does all the work, i.e., selecting either the <code>PCA</code> / <code>ICA</code>-<code>LDA</code> or <code>ranger</code> as the <code>proxy.content</code> as well as setting the parameters of the respective preprocessing <a href="https://mlr3pipelines.mlr-org.com/reference/PipeOp.html"><code>PipeOp</code></a>s and <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>Learner</code></a>s.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>proxy_options <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">pca_ica_lda =</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ppl</span>(<span class="st">"branch"</span>, <span class="at">graphs =</span> <span class="fu">list</span>(<span class="at">pca =</span> <span class="fu">po</span>(<span class="st">"pca"</span>), <span class="at">ica =</span> <span class="fu">po</span>(<span class="st">"ica"</span>))) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">lrn</span>(<span class="st">"classif.lda"</span>),</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">ranger =</span> <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Above, we made use of the <code>branch</code> <a href="https://mlr3pipelines.mlr-org.com/reference/ppl.html"><code>ppl</code></a> allowing us to easily construct a branching graph. Of course we also could have use another nested <code>PipeOpProxy</code> to specify the preprocessing options (<code>"pca"</code> vs.&nbsp;<code>"ica"</code>) within <code>proxy_options</code> if for some reason we do not want to do branching at all. The <code>trafo</code> function below selects one of the <code>proxy_options</code> from above and sets the respective parameters for the <code>PCA</code>, <code>ICA</code>, <code>LDA</code> and <code>ranger</code>. Here, the argument <code>x</code> is a list which will contain sampled / selected parameters from our <code>ParamSet</code> (in our case, <code>tune_ps2</code>). The return value is a list only including the appropriate <code>proxy.content</code> parameter. In each tuning iteration, the <code>proxy.content</code> parameter of our graph will be set to this value.</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>tune_ps2<span class="sc">$</span>trafo <span class="ot">=</span> <span class="cf">function</span>(x, param_set) {</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  proxy.content <span class="ot">=</span> proxy_options[[x<span class="sc">$</span>branch_learner.selection]]</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x<span class="sc">$</span>branch_learner.selection <span class="sc">==</span> <span class="st">"pca_ica_lda"</span>) {</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># pca_ica_lda</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>branch.selection <span class="ot">=</span> x<span class="sc">$</span>branch_preproc_lda.selection</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (x<span class="sc">$</span>branch_preproc_lda.selection <span class="sc">==</span> <span class="st">"pca"</span>) {</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>      proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>pca.rank. <span class="ot">=</span> x<span class="sc">$</span>pca.rank.</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>      proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>ica.n.comp <span class="ot">=</span> x<span class="sc">$</span>ica.n.comp</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>classif.lda.method <span class="ot">=</span> x<span class="sc">$</span>classif.lda.method</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ranger</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>mtry <span class="ot">=</span> x<span class="sc">$</span>classif.ranger.mtry</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    proxy.content<span class="sc">$</span>param_set<span class="sc">$</span>values<span class="sc">$</span>num.trees <span class="ot">=</span> x<span class="sc">$</span>classif.ranger.num.trees</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">proxy.content =</span> proxy.content)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>I.e., suppose that the following parameters will be selected from our <code>ParamSet</code>:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch_learner.selection =</span> <span class="st">"ranger"</span>,</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.ranger.mtry =</span> <span class="dv">200</span>,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">classif.ranger.num.trees =</span> <span class="dv">500</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The <code>trafo</code> function will then return:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>tune_ps2<span class="sc">$</span><span class="fu">trafo</span>(x)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>$proxy.content
&lt;LearnerClassifRanger:classif.ranger&gt;
* Model: -
* Parameters: num.threads=1, mtry=200, num.trees=500
* Packages: mlr3, mlr3learners, ranger
* Predict Types:  [response], prob
* Feature Types: logical, integer, numeric, character, factor, ordered
* Properties: hotstart_backward, importance, multiclass, oob_error, twoclass, weights</code></pre>
</div>
</div>
<p>Tuning can be carried out analogously as done above:</p>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>tune2 <span class="ot">=</span> TuningInstanceSingleCrit<span class="sc">$</span><span class="fu">new</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  task_train,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph2,</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">3</span>),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.acc"</span>),</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> tune_ps2,</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">terminator =</span> <span class="fu">trm</span>(<span class="st">"none"</span>)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>tuner_gs<span class="sc">$</span><span class="fu">optimize</span>(tune2)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="cell" data-layout-align="center">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(tune2<span class="sc">$</span>archive)[<span class="fu">order</span>(classif.acc), ]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-morais2018" class="csl-entry" role="listitem">
Morais, Camilo LM, and Kássio MG Lima. 2018. <span>“Principal Component Analysis with Linear and Quadratic Discriminant Analysis for Identification of Cancer Samples Based on Mass Spectrometry.”</span> <em>Journal of the Brazilian Chemical Society</em> 29 (3): 472–81. <a href="https://doi.org/10.21577/0103-5053.20170159">https://doi.org/10.21577/0103-5053.20170159</a>.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mlr-org\.com\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Created with <i class="bi bi-heart-fill"></i> for #rstats.</p>
</div>   
    <div class="nav-footer-center">
<p>CC BY SA 4.0</p>
</div>
    <div class="nav-footer-right">
<p>Website powered by <a href="https://quarto.org/">quarto</a> and <a href="https://www.netlify.com/">Netlify</a>.</p>
</div>
  </div>
</footer>




</body></html>
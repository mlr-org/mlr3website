<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Jakob Richter">
<meta name="author" content="Bernd Bischl">
<meta name="dcterms.date" content="2020-02-01">
<meta name="description" content="Tune over multiple learners for a single task.">

<title>Tuning Over Multiple Learners – mlr-org</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../images/favicon.ico" rel="icon">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-0217fbee799b1e5c46e1a9544cf407f3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": true,
  "collapse-after": 2,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 5,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">mlr-org</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-overview" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Overview</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-overview">    
        <li>
    <a class="dropdown-item" href="../../../ecosystem.html">
 <span class="dropdown-text">Ecosystem</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../dependencies.html">
 <span class="dropdown-text">Dependencies</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../tasks.html">
 <span class="dropdown-text">Tasks</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../learners.html">
 <span class="dropdown-text">Learners</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../resamplings.html">
 <span class="dropdown-text">Resamplings</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../measures.html">
 <span class="dropdown-text">Measures</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../pipeops.html">
 <span class="dropdown-text">Pipeline Operators</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../graphs.html">
 <span class="dropdown-text">Graphs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../torch_pipeops.html">
 <span class="dropdown-text">Torch Pipeline Operators</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../tuners.html">
 <span class="dropdown-text">Tuners</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../tuning_spaces.html">
 <span class="dropdown-text">Tuning Spaces</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../terminators.html">
 <span class="dropdown-text">Terminators</span></a>
  </li>  
        <li><hr class="dropdown-divider"></li>
        <li>
    <a class="dropdown-item" href="../../../filters.html">
 <span class="dropdown-text">Feature Selection Filter</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../fselectors.html">
 <span class="dropdown-text">Feature Selection Wrapper</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../resources.html"> 
<span class="menu-text">Resources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../book.html"> 
<span class="menu-text">Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../gallery.html"> 
<span class="menu-text">Gallery</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-benchmarks" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Benchmarks</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-benchmarks">    
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3.html">
 <span class="dropdown-text">mlr3</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3fselect.html">
 <span class="dropdown-text">mlr3fselect</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_mlr3tuning.html">
 <span class="dropdown-text">mlr3tuning</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../benchmarks/benchmarks_async.html">
 <span class="dropdown-text">mlr3tuning async</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item">
    <a class="nav-link" href="../../../team.html"> 
<span class="menu-text">Team</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-more" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">More</span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-more">    
        <li>
    <a class="dropdown-item" href="../../../support.html">
 <span class="dropdown-text">Support</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../contributing.html">
 <span class="dropdown-text">Contributing</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../faq.html">
 <span class="dropdown-text">Frequently Asked Questions</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../../blogroll.html">
 <span class="dropdown-text">Blogroll</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-bi-rss" role="link" data-bs-toggle="dropdown" aria-expanded="false">
      <i class="bi bi-rss" role="img">
</i> 
 <span class="menu-text"></span>
    </a>
    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="nav-menu-bi-rss">    
        <li>
    <a class="dropdown-item" href="../../../gallery-all.xml">
 <span class="dropdown-text">Gallery RSS</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item compact">
    <a class="nav-link" href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite"> <i class="bi bi-chat-dots" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://stackoverflow.com/questions/tagged/mlr3"> <i class="bi bi-stack-overflow" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/mlr-org"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Tuning Over Multiple Learners</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
  <div id="quarto-announcement" data-announcement-id="50f0eab22d7d8f5381fa1ea26eadc5d4" class="alert alert-primary hidden"><i class="bi bi-info-circle quarto-announcement-icon"></i><div class="quarto-announcement-content">
<p>The website features runtime and memory <a href="benchmarks/benchmarks_mlr3tuning.qmd">benchmarks</a> of the mlr3tuning package now.</p>
</div><i class="bi bi-x-lg quarto-announcement-action"></i></div>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Tuning Over Multiple Learners</h1>
                  <div>
        <div class="description">
          <p>Tune over multiple learners for a single task.</p>
        </div>
      </div>
                </div>
  </div>

  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Authors</div>
      <div class="quarto-title-meta-contents">
               <p>Jakob Richter </p>
               <p>Bernd Bischl </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 1, 2020</p>
      </div>
    </div>
    
      
    </div>
    

  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-setup" id="toc-the-setup" class="nav-link active" data-scroll-target="#the-setup">The Setup</a></li>
  <li><a href="#default-parameters" id="toc-default-parameters" class="nav-link" data-scroll-target="#default-parameters">Default Parameters</a></li>
  <li><a href="#the-benchmark-table-approach" id="toc-the-benchmark-table-approach" class="nav-link" data-scroll-target="#the-benchmark-table-approach">The Benchmark-Table Approach</a></li>
  <li><a href="#the-pipelines-approach" id="toc-the-pipelines-approach" class="nav-link" data-scroll-target="#the-pipelines-approach">The Pipelines Approach</a></li>
  <li><a href="#model-selection-and-tuning-with-pipelines" id="toc-model-selection-and-tuning-with-pipelines" class="nav-link" data-scroll-target="#model-selection-and-tuning-with-pipelines">Model-Selection and Tuning with Pipelines</a></li>
  <li><a href="#define-the-search-space" id="toc-define-the-search-space" class="nav-link" data-scroll-target="#define-the-search-space">Define the Search Space</a></li>
  <li><a href="#tune-the-pipeline-with-a-random-search" id="toc-tune-the-pipeline-with-a-random-search" class="nav-link" data-scroll-target="#tune-the-pipeline-with-a-random-search">Tune the Pipeline with a Random Search</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This use case shows how to tune over multiple learners for a single task. You will learn the following:</p>
<ul>
<li>Build a pipeline that can switch between multiple learners</li>
<li>Define the hyperparameter search space for the pipeline</li>
<li>Run a random or grid search (or any other tuner, always works the same)</li>
<li>Run nested resampling for unbiased performance estimates</li>
</ul>
<p>This is an advanced use case. What should you know before:</p>
<ul>
<li><a href="https://mlr3.mlr-org.com">mlr3</a> basics</li>
<li><a href="https://mlr3tuning.mlr-org.com">mlr3tuning</a> basics, especially <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a></li>
<li><a href="https://mlr3pipelines.mlr-org.com">mlr3pipelines</a>, especially branching</li>
</ul>
<section id="the-setup" class="level1">
<h1>The Setup</h1>
<p>Assume, you are given some ML task and what to compare a couple of learners, probably because you want to select the best of them at the end of the analysis. That’s a super standard scenario, it actually sounds so common that you might wonder: Why an (advanced) blog post about this? With pipelines? We will consider 2 cases: (a) Running the learners in their default, so without tuning, and (b) with tuning.</p>
<p>We load the <a href="https://mlr3verse.mlr-org.com">mlr3verse</a> package which pulls in the most important packages for this example. The <a href="https://mlr3learners.mlr-org.com">mlr3learners</a> package loads additional <a href="https://mlr3.mlr-org.com/reference/Learner.html"><code>learners</code></a>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3verse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3tuning)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlr3learners)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We initialize the random number generator with a fixed seed for reproducibility, and decrease the verbosity of the logger to keep the output clearly represented.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7832</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"mlr3"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>lgr<span class="sc">::</span><span class="fu">get_logger</span>(<span class="st">"bbotk"</span>)<span class="sc">$</span><span class="fu">set_threshold</span>(<span class="st">"warn"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s define our learners.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>learners <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.xgboost"</span>, <span class="at">id =</span> <span class="st">"xgb"</span>, <span class="at">eval_metric =</span> <span class="st">"logloss"</span>),</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lrn</span>(<span class="st">"classif.ranger"</span>, <span class="at">id =</span> <span class="st">"rf"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>learners_ids <span class="ot">=</span> <span class="fu">sapply</span>(learners, <span class="cf">function</span>(x) x<span class="sc">$</span>id)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>task <span class="ot">=</span> <span class="fu">tsk</span>(<span class="st">"sonar"</span>) <span class="co"># some random data for this demo</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>inner_cv2 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">2</span>) <span class="co"># inner loop for nested CV</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>outer_cv5 <span class="ot">=</span> <span class="fu">rsmp</span>(<span class="st">"cv"</span>, <span class="at">folds =</span> <span class="dv">5</span>) <span class="co"># outer loop for nested CV</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="default-parameters" class="level1">
<h1>Default Parameters</h1>
</section>
<section id="the-benchmark-table-approach" class="level1">
<h1>The Benchmark-Table Approach</h1>
<p>Assume we don’t want to perform tuning and or with running all learner in their respective defaults. Simply run benchmark on the learners and the tasks. That tabulates our results nicely and shows us what works best.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">=</span> <span class="fu">benchmark_grid</span>(task, learners, outer_cv5)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>bmr <span class="ot">=</span> <span class="fu">benchmark</span>(grid)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>bmr<span class="sc">$</span><span class="fu">aggregate</span>(<span class="at">measures =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   nr task_id learner_id resampling_id iters classif.ce
1:  1   sonar        xgb            cv     5  0.2736353
2:  2   sonar         rf            cv     5  0.1973287
Hidden columns: resample_result</code></pre>
</div>
</div>
</section>
<section id="the-pipelines-approach" class="level1">
<h1>The Pipelines Approach</h1>
<p>Ok, why would we ever want to change the simple approach above - and use pipelines / tuning for this? Three reasons:</p>
<ol type="1">
<li>What we are doing with <a href="https://mlr3.mlr-org.com/reference/benchmark.html"><code>benchmark()</code></a> is actually statistically flawed, insofar if we report the error of the numerically best method from the benchmark table as its estimated future performance. If we do that we have “optimized on the CV” (we basically ran a grid search over our learners!) and we know that this is will produce optimistically biased results. NB: This is a somewhat ridiculous criticism if we are going over only a handful of options, and the bias will be very small. But it will be noticeable if we do this over hundreds of learners, so it is important to understand the underlying problem. This is a somewhat subtle point, and this gallery post is more about technical hints for <a href="https://mlr3.mlr-org.com">mlr3</a>, so we will stop this discussion here.</li>
<li>For some tuning algorithms, you might have a chance to more efficiently select from the set of algorithms than running the full benchmark. Because of the categorical nature of the problem, you will not be able to learn stuff like “If learner A works bad, I don’t have to try learner B”, but you can potentially save some resampling iterations. Assume you have so select from 100 candidates, experiments are expensive, and you use a 20-fold CV. If learner A has super-bad results in the first 5 folds of the CV, you might already want to stop here. “Racing” would be such a tuning algorithm.</li>
<li>It helps us to foreshadow what comes later in this post where we tune the learners.</li>
</ol>
<p>The pipeline just has a single purpose in this example: It should allow us to switch between different learners, depending on a hyperparameter. The pipe consists of three elements:</p>
<ul>
<li><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_branch.html"><code>branch</code></a> pipes incoming data to one of the following elements, on different data channels. We can name these channel on construction with <code>options</code>.</li>
<li>our learners (combined with <a href="https://mlr3pipelines.mlr-org.com/reference/gunion.html"><code>gunion()</code></a>)</li>
<li><a href="https://mlr3pipelines.mlr-org.com/reference/mlr_pipeops_unbranch.html"><code>unbranch</code></a> combines the forked paths at the end.</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>graph <span class="ot">=</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"branch"</span>, <span class="at">options =</span> learners_ids) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gunion</span>(<span class="fu">lapply</span>(learners, po)) <span class="sc">%&gt;&gt;%</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">po</span>(<span class="st">"unbranch"</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(graph, <span class="at">html =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/2020-02-01-tuning-multiplexer-006-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The pipeline has now quite a lot of available hyperparameters. It includes all hyperparameters from all contained learners. But as we don’t tune them here (yet), we don’t care (yet). But the first hyperparameter is special. <code>branch.selection</code> controls over which (named) branching channel our data flows.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span>param_set<span class="sc">$</span><span class="fu">ids</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "branch.selection"                "xgb.alpha"                       "xgb.approxcontrib"              
 [4] "xgb.base_score"                  "xgb.booster"                     "xgb.callbacks"                  
 [7] "xgb.colsample_bylevel"           "xgb.colsample_bynode"            "xgb.colsample_bytree"           
[10] "xgb.disable_default_eval_metric" "xgb.early_stopping_rounds"       "xgb.early_stopping_set"         
[13] "xgb.eta"                         "xgb.eval_metric"                 "xgb.feature_selector"           
[16] "xgb.feval"                       "xgb.gamma"                       "xgb.grow_policy"                
[19] "xgb.interaction_constraints"     "xgb.iterationrange"              "xgb.lambda"                     
[22] "xgb.lambda_bias"                 "xgb.max_bin"                     "xgb.max_delta_step"             
[25] "xgb.max_depth"                   "xgb.max_leaves"                  "xgb.maximize"                   
[28] "xgb.min_child_weight"            "xgb.missing"                     "xgb.monotone_constraints"       
[31] "xgb.normalize_type"              "xgb.nrounds"                     "xgb.nthread"                    
[34] "xgb.ntreelimit"                  "xgb.num_parallel_tree"           "xgb.objective"                  
[37] "xgb.one_drop"                    "xgb.outputmargin"                "xgb.predcontrib"                
[40] "xgb.predictor"                   "xgb.predinteraction"             "xgb.predleaf"                   
[43] "xgb.print_every_n"               "xgb.process_type"                "xgb.rate_drop"                  
[46] "xgb.refresh_leaf"                "xgb.reshape"                     "xgb.seed_per_iteration"         
[49] "xgb.sampling_method"             "xgb.sample_type"                 "xgb.save_name"                  
[52] "xgb.save_period"                 "xgb.scale_pos_weight"            "xgb.skip_drop"                  
[55] "xgb.strict_shape"                "xgb.subsample"                   "xgb.top_k"                      
[58] "xgb.training"                    "xgb.tree_method"                 "xgb.tweedie_variance_power"     
[61] "xgb.updater"                     "xgb.verbose"                     "xgb.watchlist"                  
[64] "xgb.xgb_model"                   "rf.alpha"                        "rf.always.split.variables"      
[67] "rf.class.weights"                "rf.holdout"                      "rf.importance"                  
[70] "rf.keep.inbag"                   "rf.max.depth"                    "rf.min.node.size"               
[73] "rf.min.prop"                     "rf.minprop"                      "rf.mtry"                        
[76] "rf.mtry.ratio"                   "rf.num.random.splits"            "rf.num.threads"                 
[79] "rf.num.trees"                    "rf.oob.error"                    "rf.regularization.factor"       
[82] "rf.regularization.usedepth"      "rf.replace"                      "rf.respect.unordered.factors"   
[85] "rf.sample.fraction"              "rf.save.memory"                  "rf.scale.permutation.importance"
[88] "rf.se.method"                    "rf.seed"                         "rf.split.select.weights"        
[91] "rf.splitrule"                    "rf.verbose"                      "rf.write.forest"                </code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>graph<span class="sc">$</span>param_set<span class="sc">$</span>params<span class="sc">$</span>branch.selection</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 id    class lower upper levels        default
1: branch.selection ParamFct    NA    NA xgb,rf &lt;NoDefault[3]&gt;</code></pre>
</div>
</div>
<p>We can now tune over this pipeline, and probably running grid search seems a good idea to “touch” every available learner. NB: We have now written down in (much more complicated code) what we did before with <code>benchmark</code>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>graph_learner <span class="ot">=</span> <span class="fu">as_learner</span>(graph)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>graph_learner<span class="sc">$</span>id <span class="ot">=</span> <span class="st">"g"</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>search_space <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch.selection =</span> <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"rf"</span>, <span class="st">"xgb"</span>))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph_learner,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> inner_cv2,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> search_space</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance<span class="sc">$</span>archive)[, <span class="fu">list</span>(branch.selection, classif.ce)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   branch.selection classif.ce
1:               rf  0.1778846
2:              xgb  0.3269231</code></pre>
</div>
</div>
<p>But: Via this approach we can now get unbiased performance results via nested resampling and using the <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a> (which would make much more sense if we would select from 100 models and not 2).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>at <span class="ot">=</span> <span class="fu">auto_tuner</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>),</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph_learner,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> inner_cv2,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> search_space</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">resample</span>(task, at, outer_cv5, <span class="at">store_models =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Access inner tuning result.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extract_inner_tuning_results</span>(rr)[, <span class="fu">list</span>(iteration, branch.selection, classif.ce)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   iteration branch.selection classif.ce
1:         1               rf  0.2349398
2:         2               rf  0.1626506
3:         3               rf  0.3012048
4:         4               rf  0.2813396
5:         5               rf  0.2932444</code></pre>
</div>
</div>
<p>Access inner tuning archives.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extract_inner_tuning_archives</span>(rr)[, <span class="fu">list</span>(iteration, branch.selection, classif.ce, resample_result)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    iteration branch.selection classif.ce      resample_result
 1:         1               rf  0.2349398 &lt;ResampleResult[21]&gt;
 2:         1              xgb  0.2469880 &lt;ResampleResult[21]&gt;
 3:         2               rf  0.1626506 &lt;ResampleResult[21]&gt;
 4:         2              xgb  0.2530120 &lt;ResampleResult[21]&gt;
 5:         3              xgb  0.3795181 &lt;ResampleResult[21]&gt;
 6:         3               rf  0.3012048 &lt;ResampleResult[21]&gt;
 7:         4              xgb  0.3714859 &lt;ResampleResult[21]&gt;
 8:         4               rf  0.2813396 &lt;ResampleResult[21]&gt;
 9:         5              xgb  0.3353414 &lt;ResampleResult[21]&gt;
10:         5               rf  0.2932444 &lt;ResampleResult[21]&gt;</code></pre>
</div>
</div>
</section>
<section id="model-selection-and-tuning-with-pipelines" class="level1">
<h1>Model-Selection and Tuning with Pipelines</h1>
<p>Now let’s select from our given set of models and tune their hyperparameters. One way to do this is to define a search space for each individual learner, wrap them all with the <a href="https://mlr3tuning.mlr-org.com/reference/AutoTuner.html"><code>AutoTuner</code></a>, then call <a href="https://mlr3.mlr-org.com/reference/benchmark.html"><code>benchmark()</code></a> on them. As this is pretty standard, we will skip this here, and show an even neater option, where you can tune over models and hyperparameters in one go. If you have quite a large space of potential learners and combine this with an efficient tuning algorithm, this can save quite some time in tuning as you can learn during optimization which options work best and focus on them. NB: Many AutoML systems work in a very similar way.</p>
</section>
<section id="define-the-search-space" class="level1">
<h1>Define the Search Space</h1>
<p>Remember, that the pipeline contains a joint set of all contained hyperparameters. Prefixed with the respective PipeOp ID, to make names unique.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(graph<span class="sc">$</span>param_set)[, <span class="fu">list</span>(id, class, lower, upper, nlevels)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                 id    class lower upper nlevels
 1:                branch.selection ParamFct    NA    NA       2
 2:                       xgb.alpha ParamDbl     0   Inf     Inf
 3:               xgb.approxcontrib ParamLgl    NA    NA       2
 4:                  xgb.base_score ParamDbl  -Inf   Inf     Inf
 5:                     xgb.booster ParamFct    NA    NA       3
 6:                   xgb.callbacks ParamUty    NA    NA     Inf
 7:           xgb.colsample_bylevel ParamDbl     0     1     Inf
 8:            xgb.colsample_bynode ParamDbl     0     1     Inf
 9:            xgb.colsample_bytree ParamDbl     0     1     Inf
10: xgb.disable_default_eval_metric ParamLgl    NA    NA       2
11:       xgb.early_stopping_rounds ParamInt     1   Inf     Inf
12:          xgb.early_stopping_set ParamFct    NA    NA       3
13:                         xgb.eta ParamDbl     0     1     Inf
14:                 xgb.eval_metric ParamUty    NA    NA     Inf
15:            xgb.feature_selector ParamFct    NA    NA       5
16:                       xgb.feval ParamUty    NA    NA     Inf
17:                       xgb.gamma ParamDbl     0   Inf     Inf
18:                 xgb.grow_policy ParamFct    NA    NA       2
19:     xgb.interaction_constraints ParamUty    NA    NA     Inf
20:              xgb.iterationrange ParamUty    NA    NA     Inf
21:                      xgb.lambda ParamDbl     0   Inf     Inf
22:                 xgb.lambda_bias ParamDbl     0   Inf     Inf
23:                     xgb.max_bin ParamInt     2   Inf     Inf
24:              xgb.max_delta_step ParamDbl     0   Inf     Inf
25:                   xgb.max_depth ParamInt     0   Inf     Inf
26:                  xgb.max_leaves ParamInt     0   Inf     Inf
27:                    xgb.maximize ParamLgl    NA    NA       2
28:            xgb.min_child_weight ParamDbl     0   Inf     Inf
29:                     xgb.missing ParamDbl  -Inf   Inf     Inf
30:        xgb.monotone_constraints ParamUty    NA    NA     Inf
31:              xgb.normalize_type ParamFct    NA    NA       2
32:                     xgb.nrounds ParamInt     1   Inf     Inf
33:                     xgb.nthread ParamInt     1   Inf     Inf
34:                  xgb.ntreelimit ParamInt     1   Inf     Inf
35:           xgb.num_parallel_tree ParamInt     1   Inf     Inf
36:                   xgb.objective ParamUty    NA    NA     Inf
37:                    xgb.one_drop ParamLgl    NA    NA       2
38:                xgb.outputmargin ParamLgl    NA    NA       2
39:                 xgb.predcontrib ParamLgl    NA    NA       2
40:                   xgb.predictor ParamFct    NA    NA       2
41:             xgb.predinteraction ParamLgl    NA    NA       2
42:                    xgb.predleaf ParamLgl    NA    NA       2
43:               xgb.print_every_n ParamInt     1   Inf     Inf
44:                xgb.process_type ParamFct    NA    NA       2
45:                   xgb.rate_drop ParamDbl     0     1     Inf
46:                xgb.refresh_leaf ParamLgl    NA    NA       2
47:                     xgb.reshape ParamLgl    NA    NA       2
48:          xgb.seed_per_iteration ParamLgl    NA    NA       2
49:             xgb.sampling_method ParamFct    NA    NA       2
50:                 xgb.sample_type ParamFct    NA    NA       2
51:                   xgb.save_name ParamUty    NA    NA     Inf
52:                 xgb.save_period ParamInt     0   Inf     Inf
53:            xgb.scale_pos_weight ParamDbl  -Inf   Inf     Inf
54:                   xgb.skip_drop ParamDbl     0     1     Inf
55:                xgb.strict_shape ParamLgl    NA    NA       2
56:                   xgb.subsample ParamDbl     0     1     Inf
57:                       xgb.top_k ParamInt     0   Inf     Inf
58:                    xgb.training ParamLgl    NA    NA       2
59:                 xgb.tree_method ParamFct    NA    NA       5
60:      xgb.tweedie_variance_power ParamDbl     1     2     Inf
61:                     xgb.updater ParamUty    NA    NA     Inf
62:                     xgb.verbose ParamInt     0     2       3
63:                   xgb.watchlist ParamUty    NA    NA     Inf
64:                   xgb.xgb_model ParamUty    NA    NA     Inf
65:                        rf.alpha ParamDbl  -Inf   Inf     Inf
66:       rf.always.split.variables ParamUty    NA    NA     Inf
67:                rf.class.weights ParamUty    NA    NA     Inf
68:                      rf.holdout ParamLgl    NA    NA       2
69:                   rf.importance ParamFct    NA    NA       4
70:                   rf.keep.inbag ParamLgl    NA    NA       2
71:                    rf.max.depth ParamInt     0   Inf     Inf
72:                rf.min.node.size ParamInt     1   Inf     Inf
73:                     rf.min.prop ParamDbl  -Inf   Inf     Inf
74:                      rf.minprop ParamDbl  -Inf   Inf     Inf
75:                         rf.mtry ParamInt     1   Inf     Inf
76:                   rf.mtry.ratio ParamDbl     0     1     Inf
77:            rf.num.random.splits ParamInt     1   Inf     Inf
78:                  rf.num.threads ParamInt     1   Inf     Inf
79:                    rf.num.trees ParamInt     1   Inf     Inf
80:                    rf.oob.error ParamLgl    NA    NA       2
81:        rf.regularization.factor ParamUty    NA    NA     Inf
82:      rf.regularization.usedepth ParamLgl    NA    NA       2
83:                      rf.replace ParamLgl    NA    NA       2
84:    rf.respect.unordered.factors ParamFct    NA    NA       3
85:              rf.sample.fraction ParamDbl     0     1     Inf
86:                  rf.save.memory ParamLgl    NA    NA       2
87: rf.scale.permutation.importance ParamLgl    NA    NA       2
88:                    rf.se.method ParamFct    NA    NA       2
89:                         rf.seed ParamInt  -Inf   Inf     Inf
90:         rf.split.select.weights ParamUty    NA    NA     Inf
91:                    rf.splitrule ParamFct    NA    NA       3
92:                      rf.verbose ParamLgl    NA    NA       2
93:                 rf.write.forest ParamLgl    NA    NA       2
                                 id    class lower upper nlevels</code></pre>
</div>
</div>
<p>We decide to tune the <code>mtry</code> parameter of the random forest and the <code>nrounds</code> parameter of xgboost. Additionally, we tune branching parameter that selects our learner.</p>
<p>We also have to reflect the hierarchical order of the parameter sets (admittedly, this is somewhat inconvenient). We can only set the <code>mtry</code> value if the pipe is configured to use the random forest (<a href="https://mlr3learners.mlr-org.com/reference/mlr_learners_classif.ranger.html"><code>ranger</code></a>). The same applies for the xgboost parameter.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>search_space <span class="ot">=</span> <span class="fu">ps</span>(</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">branch.selection =</span> <span class="fu">p_fct</span>(<span class="fu">c</span>(<span class="st">"rf"</span>, <span class="st">"xgb"</span>)),</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">rf.mtry =</span> <span class="fu">p_int</span>(<span class="dv">1</span>L, <span class="dv">20</span>L, <span class="at">depends =</span> branch.selection <span class="sc">==</span> <span class="st">"rf"</span>),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">xgb.nrounds =</span> <span class="fu">p_int</span>(<span class="dv">1</span>, <span class="dv">500</span>, <span class="at">depends =</span> branch.selection <span class="sc">==</span> <span class="st">"xgb"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="tune-the-pipeline-with-a-random-search" class="level1">
<h1>Tune the Pipeline with a Random Search</h1>
<p>Very similar code as before, we just swap out the search space. And now use random search.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>instance <span class="ot">=</span> <span class="fu">tune</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"random_search"</span>),</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph_learner,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">resampling =</span> inner_cv2,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">10</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> search_space</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="fu">as.data.table</span>(instance<span class="sc">$</span>archive)[, <span class="fu">list</span>(branch.selection, xgb.nrounds, rf.mtry, classif.ce)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    branch.selection xgb.nrounds rf.mtry classif.ce
 1:              xgb         292      NA  0.1875000
 2:               rf          NA      19  0.2692308
 3:               rf          NA       5  0.2307692
 4:              xgb         229      NA  0.1875000
 5:              xgb         301      NA  0.1875000
 6:               rf          NA      20  0.2596154
 7:               rf          NA       8  0.2355769
 8:               rf          NA       2  0.2355769
 9:               rf          NA       5  0.2500000
10:               rf          NA      18  0.2451923</code></pre>
</div>
</div>
<p>The following shows a quick way to visualize the tuning results.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(instance, <span class="at">cols_x =</span> <span class="fu">c</span>(<span class="st">"xgb.nrounds"</span>,<span class="st">"rf.mtry"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="index_files/figure-html/2020-02-01-tuning-multiplexer-015-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Nested resampling, now really needed:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>rr <span class="ot">=</span> <span class="fu">tune_nested</span>(</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">tuner =</span> <span class="fu">tnr</span>(<span class="st">"grid_search"</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">task =</span> task,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">learner =</span> graph_learner,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">inner_resampling =</span> inner_cv2,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">outer_resampling =</span> outer_cv5,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">measure =</span> <span class="fu">msr</span>(<span class="st">"classif.ce"</span>),</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">term_evals =</span> <span class="dv">10</span>L,</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">search_space =</span> search_space)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Access inner tuning result.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">extract_inner_tuning_results</span>(rr)[, <span class="fu">list</span>(iteration, branch.selection, classif.ce)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   iteration branch.selection classif.ce
1:         1               rf  0.2108434
2:         2               rf  0.1807229
3:         3               rf  0.2289157
4:         4              xgb  0.1915519
5:         5               rf  0.1858147</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/mlr-org\.com\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>Created with <i class="bi bi-heart-fill"></i> for #rstats.</p>
</div>   
    <div class="nav-footer-center">
<p>CC BY SA 4.0</p>
</div>
    <div class="nav-footer-right">
<p>Website powered by <a href="https://quarto.org/">quarto</a> and <a href="https://www.netlify.com/">Netlify</a>.</p>
</div>
  </div>
</footer>




</body></html>
---
title: "paradox - Runtime Benchmarks"
sidebar: false
toc: true
cache: false
lazy-cache: false
format:
  html:
    fig-width: 12
    fig-height: 9
---

{{< include ../_setup.qmd >}}

```{r}
#| include: false
library(data.table)
library(ggplot2)
library(gt)
library(DBI)

con = dbConnect(RSQLite::SQLite(), here::here("mlr-org/benchmarks/results_lrz.db"))
snapshot = setDT(dbReadTable(con, "paradox_snapshots"))
snapshot[, paradox := factor(paradox)]

jobs = rowwise_table(
  ~function_name,           ~package,  ~minimum_version,   ~args,
  "initialize",             "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "ids",                    "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "ids_class",              "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "ids_tags",               "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "ids_class_tags",         "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "get_values",             "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "get_values_class",       "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "get_values_tags",        "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "get_values_class_tags",  "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "set_values",             "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "lower",                  "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "upper",                  "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "levels",                 "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "class",                  "paradox", "0.11.1",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed"))),
  "subspaces",              "paradox", "1.0.0",           list(list(size = c(5, 50, 500), type = c("numeric", "categorical", "mixed")))
)

results = set_names(pmap(jobs, function(function_name, args, ...) {
  arg_names = names(args)
  data_runtime = setDT(dbReadTable(con, sprintf("paradox_runtime_%s", function_name)))[, c(arg_names, "renv_project", "median_runtime", "mad_runtime"), with = FALSE]
  data_runtime = data_runtime[snapshot, on = "renv_project", nomatch = 0]
  setorderv(data_runtime, c(arg_names, "paradox"), order = c(rep(1, length(arg_names)), -1))
  data_runtime[, -c("renv_project")]
}), jobs$function_name)
```

# Scope

This report analyzes the runtime and memory usage of the paradox package across different versions.
The benchmarks vary the type and the size of the parameter space.

Given the extensive package ecosystem of mlr3, performance bottlenecks can occur at multiple stages.
This report aims to help users determine whether the runtime of their workflows falls within expected ranges.
If significant runtime or memory anomalies are observed, users are encouraged to report them by opening a GitHub issue.

Benchmarks are conducted on a high-performance cluster optimized for multi-core performance rather than single-core speed.
Consequently, runtimes may be faster on a local machine.

# Summary of Latest paradox Version

The benchmarks are comprehensive; therefore, we present a summary of the most important functions in the latest paradox version.
We start by measuring the runtime of the `ps()` function when initializing a parameter space in the size of 5, 50 and 500 parameters.
The runtime increases from 2 to 10 to 100 ms but is independent of the type of the parameters.
Getting values with the `$get_values()` method takes around 100 Âµs.
The `$set_values()` takes a half millisecond for 5 values and 14 ms for 500 values.

# Initialize {#initialize}

```{r}
#| include: false
plot_runtime = function(data) {
  data = copy(data)
  ggplot(data, aes(x = paradox, y = median_runtime)) +
    geom_col(group = 1, fill = "#008080") +
    geom_errorbar(aes(ymin = pmax(median_runtime - mad_runtime, 0), ymax = median_runtime + mad_runtime), width = 0.5, position = position_dodge(0.9)) +
    facet_wrap(~type +  size, scales = "free_y", labeller = labeller(type = function(value) sprintf("%s", value), size = function(value) sprintf("%s", value))) +
    labs(x = "paradox Version", y = "Runtime [ms]") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# create_table = function(data) {
#   data = data[, -c("mad_runtime")]
#   data[, task := as.integer(gsub("data_", "", task))]
#   setcolorder(data, c("mlr3", "paradox", "model_time", "task", "median_runtime", "k"))

#   data %>%
#     gt() %>%
#     cols_label(
#       mlr3 = "mlr3 Version",
#       paradox = "paradox Version",
#       model_time = "Model Time [ms]",
#       task = "Task Size",
#       median_runtime = "Median Runtime [ms]",
#       k = "K") %>%
#     fmt_number(columns = c("median_runtime"), decimals = 0, sep_mark = "") %>%
#     fmt_number(columns = c("k"), n_sigfig = 2, sep_mark = "") %>%
#     tab_style(
#       style = list(
#         cell_fill(color = "crimson"),
#         cell_text(weight = "bold")
#       ),
#       locations = cells_body(
#         columns = "k",
#         rows = k > 3
#       )
#     ) %>%
#     tab_row_group(
#       label = "10000 Observations",
#       rows = task == 10000
#     ) %>%
#     tab_row_group(
#       label = "1000 Observations",
#       rows = task == 1000
#     ) %>%
#     tab_row_group(
#       label = "100 Observations",
#       rows = task == 100
#     ) %>%
#     tab_row_group(
#       label = "10 Observations",
#       rows = task == 10
#     ) %>%
#     tab_row_group(
#       label = "1 Observation",
#       rows = task == 1
#     )
#   }
```

The runtime of the `initialize()` method is measured for different paradox versions.

```{r}
#| eval: false
param_set = ps(
  a = p_dbl(lower = 0, upper = 1),
  b = p_dbl(lower = 0, upper = 1),
  c = p_dbl(lower = 0, upper = 1),
  d = p_dbl(lower = 0, upper = 1),
  e = p_dbl(lower = 0, upper = 1)
)
```

```{r}
#| echo: false
plot_runtime(results$initialize)
```

# Ids {#ids}

The runtime usage of the `param_set$ids()` method is measured for different paradox versions.

```{r}
#| eval: false
param_set$ids()
```

```{r}
#| echo: false
plot_runtime(results$ids)
```

Subset the parameter space by class.

```{r}
#| eval: false
param_set$ids(class = "numeric")
```

```{r}
#| echo: false
plot_runtime(results$ids_class)
```

Subset the parameter space by tags.

```{r}
#| eval: false
param_set$ids(tags = "a")
```

```{r}
#| echo: false
plot_runtime(results$ids_tags)
```

Subset the parameter space by tags and class.

```{r}
#| eval: false
param_set$ids(tags = "a", class = "numeric")
```

```{r}
#| echo: false
plot_runtime(results$ids_class_tags)
```

# Get Values {#get_values}

The runtime of the `$get_values()` method is measured for different paradox versions.

```{r}
#| eval: false
param_set$get_values()
```

```{r}
#| echo: false
plot_runtime(results$get_values)
```

Subset the parameter space by class.

```{r}
#| eval: false
param_set$get_values(class = "numeric")
```

```{r}
#| echo: false
plot_runtime(results$get_values_class)
```

Subset the parameter space by tags.

```{r}
#| eval: false
param_set$get_values(tags = "a")
```

```{r}
#| echo: false
plot_runtime(results$get_values_tags)
```

Subset the parameter space by tags and class.

```{r}
#| eval: false
param_set$get_values(tags = "a", class = "numeric")
```

```{r}
#| echo: false
plot_runtime(results$get_values_class_tags)
```

# Set Values {#set_values}

The runtime of the `$set_values()` method is measured for different paradox versions.

```{r}
#| eval: false
param_set$set_values(a = 1)
```

```{r}
#| echo: false
plot_runtime(results$set_values)
```

# Lower and Upper {#lower_upper}

The runtime of getting the lower and upper bounds of the parameter space is measured for different paradox versions.

```{r}
#| eval: false
param_set$lower
```

```{r}
#| echo: false
plot_runtime(results$lower)
```

Runtime of `$upper()`.

```{r}
#| eval: false
param_set$upper
```

```{r}
#| echo: false
plot_runtime(results$upper)
```

# Levels {#levels}

The runtime of getting the levels of the parameter space is measured for different paradox versions.

```{r}
#| eval: false
param_set$levels
```

```{r}
#| echo: false
plot_runtime(results$levels)
```

# Class {#class}

The runtime of getting the classes of the parameter space is measured for different paradox versions.

```{r}
#| eval: false
param_set$class
```

```{r}
#| echo: false
plot_runtime(results$class)
```

# Subspaces {#subspaces}

```{r}
#| eval: false
param_set$subspaces()
```

```{r}
#| echo: false
plot_runtime(results$subspaces)
```


